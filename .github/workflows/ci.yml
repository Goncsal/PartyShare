name: TQS Backend CI/CD Pipeline

on:
  push:
    branches: [ main, develop, "feature/**" ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('tqsbackend/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Make Maven wrapper executable
      run: chmod +x tqsbackend/mvnw
      
    - name: Compile and build
      run: |
        cd tqsbackend
        ./mvnw clean compile
        
    - name: Run tests with coverage
      run: |
        cd tqsbackend
        ./mvnw test jacoco:report
# ... existing steps up to Run tests with coverage ...

    - name: Run tests with coverage
      run: |
        cd tqsbackend
        ./mvnw test jacoco:report
    - name: Post JUnit Report to Xray
      if: always()
      env:
        XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
        XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
        XRAY_BASE_URL: "https://xray.cloud.getxray.app/api/v2"
        JIRA_PROJECT_KEY: PS
      run: |
        echo "Starting Xray report upload..."

        # Paths
        JUNIT_REPORT_PATH="tqsbackend/target/surefire-reports/*.xml"
        XRAY_AUTH_URL="$XRAY_BASE_URL/authenticate"
        XRAY_IMPORT_URL="$XRAY_BASE_URL/import/execution/junit?projectKey=$JIRA_PROJECT_KEY"

        # Ensure at least one test report exists
        if ! ls $JUNIT_REPORT_PATH 1> /dev/null 2>&1; then
          echo "WARNING: No JUnit XML files found. Skipping Xray import."
          exit 0
        fi

        echo "1/2: Authenticating with Xray..."
        XRAY_TOKEN=$(curl -s -X POST \
          -H "Content-Type: application/json" \
          --data "{ \"client_id\": \"$XRAY_CLIENT_ID\", \"client_secret\": \"$XRAY_CLIENT_SECRET\" }" \
          $XRAY_AUTH_URL | tr -d '"')

        if [ -z "$XRAY_TOKEN" ]; then
          echo "ERROR: Failed to obtain Xray Token"
          exit 1
        fi

        echo "2/2: Uploading test results to Xray..."
        IMPORT_RESPONSE=$(curl -s -X POST \
          -H "Content-Type: text/xml" \
          -H "Authorization: Bearer $XRAY_TOKEN" \
          --data-binary "@$JUNIT_REPORT_PATH" \
          "$XRAY_IMPORT_URL")

        echo "Xray Import Response: $IMPORT_RESPONSE"

        if echo "$IMPORT_RESPONSE" | grep -q '"key":'; then
          echo "Xray Test Execution created successfully."
        else
          echo "WARNING: Xray import may have failed."
        fi


    # ... existing steps for artifacts and summary ...
        
    - name: Package application
      run: |
        cd tqsbackend
        ./mvnw package -DskipTests
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: tqsbackend/target/surefire-reports/
        
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: tqsbackend/target/site/jacoco/
        
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: tqsbackend-jar
        path: tqsbackend/target/*.jar
        
    - name: Test Report Summary
      if: always()
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        if [ -f "tqsbackend/target/surefire-reports/TEST-*.xml" ]; then
          echo "Tests completed - check artifacts for detailed reports" >> $GITHUB_STEP_SUMMARY
        else
          echo "No test results found" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Coverage Report Summary
      if: always()
      run: |
        echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
        if [ -f "tqsbackend/target/site/jacoco/index.html" ]; then
          echo "Coverage report generated - check coverage-reports artifact" >> $GITHUB_STEP_SUMMARY
        else
          echo "No coverage report found" >> $GITHUB_STEP_SUMMARY
        fi