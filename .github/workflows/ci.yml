name: TQS Backend CI/CD Pipeline

on:
  push:
    branches: [ main, develop, "feature/**" ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  checks: write
  pull-requests: write
  actions: read

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('tqsbackend/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Make Maven wrapper executable
      run: chmod +x tqsbackend/mvnw
      
    - name: Compile and build
      run: |
        cd tqsbackend
        ./mvnw clean compile
        
    - name: Run tests with coverage
      run: |
        cd tqsbackend
        ./mvnw test jacoco:report
# ... existing steps up to Run tests with coverage ...

    - name: Run tests with coverage
      run: |
        cd tqsbackend
        ./mvnw test jacoco:report
        
    # --- START of Xray Integration Step ---
    - name: Post JUnit Report to Xray
      if: always() # Run even if tests fail, so you can see failed test executions in Jira
      env:
        # These are references to your GitHub Secrets
        XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
        XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
        JIRA_BASE_URL: https://ua-team-pjkn2g78.atlassian.net
        JIRA_PROJECT_KEY: PS
      run: |
        echo "Starting Xray report upload..."
        
        # Define paths and URLs
        XRAY_AUTH_URL="https://xray.cloud.getxray.app/api/v2/authenticate"
        JUNIT_REPORT_PATH="tqsbackend/target/surefire-reports/TEST-tqs.backend.tqsbackend.TqsbackendApplicationTests.xml"
        
        # Check if the report file exists (Optional but good practice)
        if [ ! -f "$JUNIT_REPORT_PATH" ]; then
          echo "WARNING: JUnit report file not found at $JUNIT_REPORT_PATH. Skipping Xray import."
          exit 0
        fi
        
        # 1. Obtain Authentication Token
        echo "1/2: Obtaining Xray API Token..."
        # Note: The 'jq' command is used here to safely parse the JSON output and extract the token. 
        # Since 'jq' might not be available, we can stick to the 'tr' method, but 'jq' is cleaner.
        # Assuming 'curl' is the primary tool:
        XRAY_TOKEN=$(curl -s -X POST \
          -H "Content-Type: application/json" \
          --data "{ \"client_id\": \"$XRAY_CLIENT_ID\", \"client_secret\": \"$XRAY_CLIENT_SECRET\" }" \
          $XRAY_AUTH_URL | tr -d '\"')

        if [ -z "$XRAY_TOKEN" ]; then
          echo "ERROR: Failed to obtain Xray Token. Check Client ID/Secret."
          exit 1
        fi
        echo "Token successfully obtained."
        
        # 2. POST the JUnit Report to Xray
        echo "2/2: Importing JUnit results to Xray..."
        IMPORT_URL="$JIRA_BASE_URL/api/v2/import/execution/junit?projectKey=$JIRA_PROJECT_KEY"
        
        IMPORT_RESPONSE=$(curl -s -X POST \
          -H "Content-Type: text/xml" \
          -H "Authorization: Bearer $XRAY_TOKEN" \
          "$IMPORT_URL" \
          --data-binary "@$JUNIT_REPORT_PATH")

        # Output the response for verification
        echo "Xray Import Response: $IMPORT_RESPONSE"
        # Optional: Check for successful import (response contains 'id' or 'key')
        if echo "$IMPORT_RESPONSE" | grep -q '"key":'; then
          echo "Successfully created Test Execution issue: $(echo "$IMPORT_RESPONSE" | grep -o '"key":"[^"]*"' | cut -d: -f2 | tr -d '\"')"
        else
          echo "WARNING: Xray import may have failed. Response was not a standard success message."
        fi
    # --- END of Xray Integration Step ---

    # ... existing steps for artifacts and summary ...
        
    - name: Package application
      run: |
        cd tqsbackend
        ./mvnw package -DskipTests
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: tqsbackend/target/surefire-reports/
        
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: tqsbackend/target/site/jacoco/
        
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: tqsbackend-jar
        path: tqsbackend/target/*.jar
        
    - name: Test Report Summary
      if: always()
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        if [ -f "tqsbackend/target/surefire-reports/TEST-*.xml" ]; then
          echo "Tests completed - check artifacts for detailed reports" >> $GITHUB_STEP_SUMMARY
        else
          echo "No test results found" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Coverage Report Summary
      if: always()
      run: |
        echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
        if [ -f "tqsbackend/target/site/jacoco/index.html" ]; then
          echo "Coverage report generated - check coverage-reports artifact" >> $GITHUB_STEP_SUMMARY
        else
          echo "No coverage report found" >> $GITHUB_STEP_SUMMARY
        fi