<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>My Bookings - PartyShare</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
        }

        .status-REQUESTED {
            background: #fff3cd;
            color: #856404;
        }

        .status-ACCEPTED {
            background: #d4edda;
            color: #155724;
        }

        .status-REJECTED {
            background: #f8d7da;
            color: #721c24;
        }

        .status-CANCELLED {
            background: #e2e3e5;
            color: #383d41;
        }

        .status-COUNTER_OFFER {
            background: #cce5ff;
            color: #004085;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            font-weight: 600;
            color: #7f8c8d;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div>
                <h1><i class="fas fa-calendar-alt"></i> My Bookings</h1>
                <p>Manage your item rentals</p>
            </div>
            <div class="actions">
                <a href="/items/search" class="btn btn-secondary">Back to Search</a>
                <a href="/reports" class="btn btn-secondary" style="margin-left: 10px;">Reports</a>
            </div>
        </div>

        <div th:if="${success}"
            style="padding: 15px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 8px; margin-bottom: 20px;"
            th:text="${success}"></div>
        <div th:if="${error}"
            style="padding: 15px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 8px; margin-bottom: 20px;"
            th:text="${error}"></div>

        <div class="card" style="padding: 0; overflow: hidden;">
            <div th:if="${bookings.empty}" style="padding: 40px; text-align: center; color: #95a5a6;">
                <p>You have no bookings yet.</p>
                <a href="/items/search" class="btn btn-primary" style="margin-top: 10px;">Browse Items</a>
            </div>

            <div th:if="${!bookings.empty}" style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Dates</th>
                            <th>Daily Price</th>
                            <th>Total Price</th>
                            <th>Status</th>
                            <th>Reference</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="booking : ${bookings}">
                            <td>
                                <a th:href="@{/items/{id}(id=${booking.item.id})}"
                                    style="color: #2c3e50; font-weight: bold; text-decoration: none;"
                                    th:text="${booking.item.name}">Item Name</a>
                            </td>
                            <td th:text="${booking.startDate} + ' to ' + ${booking.endDate}" style="color: #555;">Dates
                            </td>
                            <td th:text="'€' + ${booking.dailyPrice}" style="color: #555;">Daily Price</td>
                            <td th:text="'€' + ${booking.totalPrice}" style="font-weight: bold; color: #d35400;">Total
                                Price</td>
                            <td>
                                <span class="status-badge" th:classappend="'status-' + ${booking.status}"
                                    th:text="${booking.status}">Status</span>
                            </td>
                            <td th:text="${booking.paymentReference}" style="font-family: monospace; color: #555;">
                                Reference</td>
                            <td>
                                <div th:if="${booking.status.toString() == 'COUNTER_OFFER'}"
                                    style="display: flex; gap: 5px;">
                                    <form th:action="@{/bookings/{id}/accept-counter-offer(id=${booking.id})}"
                                        method="post" style="display:inline;">
                                        <button type="submit" class="btn btn-primary"
                                            style="padding: 5px 10px; font-size: 0.8em; background-color: #27ae60;">Accept</button>
                                    </form>
                                    <form th:action="@{/bookings/{id}/decline-counter-offer(id=${booking.id})}"
                                        method="post" style="display:inline;">
                                        <button type="submit" class="btn btn-secondary"
                                            style="padding: 5px 10px; font-size: 0.8em; background-color: #e74c3c;">Decline</button>
                                    </form>
                                </div>

                                <div th:if="${booking.status.toString() == 'ACCEPTED' and booking.paymentStatus.toString() == 'PENDING'}"
                                    style="margin-bottom: 5px;">
                                    <a th:href="@{/payment/{id}(id=${booking.id})}" class="btn btn-primary"
                                        style="text-decoration: none; display: inline-block; padding: 5px 10px; font-size: 0.8em;">Pay
                                        Now</a>
                                </div>

                                <form
                                    th:if="${(booking.status.toString() == 'REQUESTED' or booking.status.toString() == 'ACCEPTED') and #temporals.createToday().isBefore(booking.endDate)}"
                                    th:action="@{/bookings/{id}/cancel(id=${booking.id})}" method="post"
                                    style="display:inline;">
                                    <button type="submit" class="btn btn-secondary"
                                        style="padding: 5px 10px; font-size: 0.8em; background-color: #e74c3c;"
                                        onclick="return confirm('Are you sure you want to cancel this booking?')">
                                        Cancel
                                    </button>
                                </form>

                                <!-- Confirm Return Button (for early/normal returns) -->
                                <button
                                    th:if="${booking.status.toString() == 'ACCEPTED' and booking.paymentStatus.toString() == 'PAID' and !booking.renterConfirmed}"
                                    class="btn btn-primary"
                                    style="padding: 5px 10px; font-size: 0.8em; background-color: #27ae60;"
                                    th:onclick="'confirmReturn(' + ${booking.id} + ')'">
                                    ✓ Confirm Return
                                </button>
                                <span th:if="${booking.renterConfirmed}" class="btn btn-secondary"
                                    style="padding: 5px 10px; font-size: 0.8em; background-color: #95a5a6; cursor: default;">
                                    ✓ Return Confirmed
                                </span>

                                <span
                                    th:if="${booking.status.toString() == 'CANCELLED' or booking.status.toString() == 'REJECTED'}"
                                    style="color: #95a5a6;">-</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function confirmReturn(bookingId) {
            if (!confirm('Confirm that you have returned the item?')) {
                return;
            }

            fetch(`/api/bookings/${bookingId}/confirm-return`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        alert('Return confirmed! Funds will be released when the owner also confirms.');
                        location.reload();
                    } else {
                        return response.text().then(text => {
                            throw new Error(text || 'Failed to confirm');
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error: ' + error.message);
                });
        }
    </script>
</body>

</html>